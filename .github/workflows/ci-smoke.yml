name: CI Smoke

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  unit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install minimal deps (no paddleocr)
        run: |
          python -m pip install --upgrade pip
          pip install \
            fastapi==0.110.0 uvicorn[standard]==0.29.0 \
            numpy==1.24.4 python-multipart==0.0.9 python-dotenv==1.0.1 \
            prometheus-client==0.20.0 Pillow==10.1.0 \
            pytest httpx==0.27.0
      - name: Run tests
        run: pytest -q

  python-smoke:
    runs-on: ubuntu-latest
    needs: unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install minimal deps (no paddleocr)
        run: |
          python -m pip install --upgrade pip
          pip install \
            fastapi==0.110.0 uvicorn[standard]==0.29.0 \
            numpy==1.24.4 python-multipart==0.0.9 python-dotenv==1.0.1 \
            prometheus-client==0.20.0 Pillow==10.1.0 httpx==0.27.0
      - name: Launch server
        env:
          APP_HOST: 127.0.0.1
          APP_PORT: 5001
          OCR_USE_GPU: 'false'
          OCR_WARMUP_ON_START: 'false'
          METRICS_ENABLED: 'false'
        run: |
          nohup python -c 'import uvicorn, os; os.environ.setdefault("APP_HOST","127.0.0.1"); os.environ.setdefault("APP_PORT","5001"); import server; uvicorn.run(server.app, host=os.getenv("APP_HOST"), port=int(os.getenv("APP_PORT")))' >/tmp/uvicorn.log 2>&1 &
          for i in $(seq 1 30); do \
            curl -fsS http://127.0.0.1:5001/healthz && break || sleep 1; \
          done
      - name: Smoke endpoints
        run: |
          set -e
          curl -fsS http://127.0.0.1:5001/healthz | tee /tmp/healthz.json
          curl -fsS http://127.0.0.1:5001/ui | grep -F "PaddleOCR Server â€” Web UI"
          curl -fsS http://127.0.0.1:5001/meta | tee /tmp/meta.json
          # readyz may be 503 (OCR engine disabled), treat as non-fatal
          curl -s -o /dev/null -w "%{http_code}\n" http://127.0.0.1:5001/readyz || true
